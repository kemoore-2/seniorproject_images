<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.C. A&T Stats Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'aggie-blue': '#004b8d',
                        'aggie-gold': '#fdb927',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    
    <style>
        /* Custom styles for a consistent look */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .data-card {
            @apply bg-aggie-blue bg-opacity-10 border border-blue-900 rounded-lg p-4 shadow-md;
        }
        .data-value {
            @apply text-3xl font-bold text-aggie-gold;
        }
        .data-label {
            @apply text-sm font-medium text-aggie-blue uppercase tracking-wider;
        }
        .stat-button {
            @apply px-4 py-2 rounded-md text-sm font-medium transition-colors duration-150;
        }
        .stat-button.active {
            @apply bg-aggie-gold text-aggie-blue;
        }
        .stat-button.inactive {
            @apply bg-blue-900 text-aggie-gold hover:bg-blue-800;
        }
        .tab-button {
            @apply w-full px-6 py-4 text-lg font-semibold transition-colors duration-150 rounded-t-lg mx-1; 
        }
        .tab-button.active {
            @apply bg-gray-800 text-aggie-gold border-t-4 border-aggie-gold; 
        }
        .tab-button.inactive {
            @apply bg-blue-900 text-white hover:bg-blue-800 opacity-80 hover:opacity-100;
        }
        .tab-panel {
            @apply bg-gray-800 p-8 rounded-b-lg shadow-2xl mt-0; 
        }
        
        /* High Contrast Input Field (White BG, Dark Blue Text) */
        .input-field {
            @apply w-full px-3 py-2 bg-white border-2 border-aggie-blue rounded-md font-bold focus:outline-none focus:ring-2 focus:ring-aggie-gold focus:border-transparent;
            
            /* FORCE Text Color to be Dark Blue/Black */
            color: #004b8d !important;
            
            /* FORCE Browser to render standard form controls */
            color-scheme: light;
        }

        /* Fix for dropdown options being unreadable */
        .input-field option {
            color: black !important;
            background-color: white !important;
        }
        .input-label {
            @apply block text-sm font-medium text-aggie-gold mb-2;
        }
        .prediction-output-card {
            @apply bg-blue-900 bg-opacity-50 rounded-lg p-4 text-center border border-aggie-gold;
        }
        .prediction-output-value {
            @apply text-2xl font-bold text-white;
        }
        .prediction-output-label {
            @apply text-xs text-aggie-gold uppercase tracking-wide mt-1;
        }
        
        /* Accuracy Table Styles */
        .accuracy-table {
            @apply w-full text-left border-collapse;
            min-width: 800px; /* Force horizontal scroll on small screens if needed */
        }
        .accuracy-table th {
            @apply bg-blue-900 text-aggie-gold p-4 border-b border-gray-600 font-bold text-base tracking-wide; 
        }
        .accuracy-table td {
            @apply p-4 border-b border-gray-700 text-gray-200 text-base; 
        }
        .accuracy-table tr:hover {
            @apply bg-gray-700 transition-colors duration-150;
        }
        /* Add subtle vertical dividers for clarity */
        .accuracy-table th:not(:last-child),
        .accuracy-table td:not(:last-child) {
            @apply border-r border-gray-700;
        }
        
        .diff-positive { @apply text-green-400 font-bold; }
        .diff-negative { @apply text-red-400 font-bold; }
        .diff-neutral { @apply text-gray-400; }
    </style>
</head>

<body class="bg-aggie-blue font-sans text-white p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-aggie-gold mb-8">
            N.C. A&T Dynamic Stats Tracker
        </h1>

        <div class="w-full max-w-6xl mx-auto">
            <div class="flex justify-center mb-0 overflow-x-auto space-x-2"> 
                <button id="tab-btn-charts" class="tab-button active" onclick="showTab('charts')">
                    View Charts
                </button>
                <button id="tab-btn-prediction" class="tab-button inactive" onclick="showTab('prediction')">
                    Prediction Sandbox
                </button>
                <button id="tab-btn-accuracy" class="tab-button inactive" onclick="showTab('accuracy')">
                    Model Validation
                </button>
                <button id="tab-btn-visualization" class="tab-button inactive" onclick="showTab('visualization')">
                    Advanced Data Visualization
                </button>
            </div>

            <div id="tab-panel-charts" class="tab-panel">
                <div class="mb-6">
                    <label for="dataset-select" class="input-label">
                        Select Dataset:
                    </label>
                    <select id="dataset-select" class="input-field">
                        <option value="men_season_avg">Men's Season Averages (Games 1-4)</option>
                        <option value="women_season_avg">Women's Season Averages</option>
                        <option value="men_game_11_18">Men's Game (11/18 vs Morgan St.)</option>
                        <option value="men_game_11_13">Men's Game (11/13 vs Wash. Adventist)</option>
                        <option value="men_game_11_10">Men's Game (11/04 vs S. Carolina)</option>
                        <option value="men_game_1_2_avg">Men's Game 1-2 Averages</option>
                    </select>
                </div>

                <div id="stat-buttons-container" class="mb-6 flex flex-wrap justify-center gap-2">
                    </div>

                <div id="team-summary-container" class="hidden mb-6">
                    <h3 id="team-summary-title" class="text-xl font-semibold text-aggie-gold mb-3 text-center">Team Summary</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="data-card text-center">
                            <div id="bench-points" class="data-value">0</div>
                            <div class="data-label">Bench Points</div>
                        </div>
                        <div class="data-card text-center">
                            <div id="fast-break-points" class="data-value">0</div>
                            <div class="data-label">Fast Break Points</div>
                        </div>
                        <div class="data-card text-center">
                            <div id="points-off-turnovers" class="data-value">0</div>
                            <div class="data-label">Points off TOs</div>
                        </div>
                        <div class="data-card text-center">
                            <div id="points-in-paint" class="data-value">0</div>
                            <div class="data-label">Points in Paint</div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 p-4 rounded-lg shadow-inner">
                    <div id="chart-wrapper" style="position: relative; height: 600px;">
                        <canvas id="playerStatsChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-panel-prediction" class="tab-panel hidden">
                <div class="mb-4 flex justify-between items-center">
                    <button onclick="showTab('charts')" class="flex items-center text-sm font-bold text-aggie-gold hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        Back to Dataset
                    </button>
                </div>

                <div class="max-w-md mx-auto">
                    <h2 class="text-2xl font-bold text-center text-aggie-gold mb-4">
                        Performance Prediction Sandbox
                    </h2>
                    
                    <div class="mb-6">
                        <label for="predict-game-select" class="input-label text-center">Predicting For:</label>
                        <select id="predict-game-select" class="input-field text-center">
                            <option value="game5">Upcoming Game 5 (Train on G1-4)</option>
                            <option value="game4">Game 4 (Train on G1-3)</option>
                            <option value="game3">Game 3 (Train on G1-2)</option>
                        </select>
                        <p id="prediction-context-text" class="text-center text-xs text-gray-400 mt-2">
                            Using <strong>Player-Specific</strong> Efficiency Ratings (PPM/RPM/APM).
                        </p>
                    </div>
                    
                    <div class="mb-6">
                        <label for="player-select" class="input-label">Select Player (to load baseline):</label>
                        <select id="player-select" class="input-field">
                            </select>
                    </div>

                    <div class="mb-8">
                        <label for="minutes-input" class="input-label text-center text-lg">Projected Minutes</label>
                        <div class="flex justify-center">
                            <input type="number" id="minutes-input" min="0" max="40" step="1" class="input-field w-32 text-center text-2xl">
                        </div>
                        <input type="range" id="minutes-slider" min="0" max="40" step="1" class="w-full mt-4 accent-aggie-gold">
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="prediction-output-card">
                            <div id="pred-pts" class="prediction-output-value">--</div>
                            <div class="prediction-output-label">Points</div>
                        </div>
                        <div class="prediction-output-card">
                            <div id="pred-reb" class="prediction-output-value">--</div>
                            <div class="prediction-output-label">Rebounds</div>
                        </div>
                        <div class="prediction-output-card">
                            <div id="pred-ast" class="prediction-output-value">--</div>
                            <div class="prediction-output-label">Assists</div>
                        </div>
                    </div>
                    
                    <div id="model-info" class="text-xs text-gray-400 text-center mt-4">
                        </div>
                </div>
            </div>
            
            <div id="tab-panel-accuracy" class="tab-panel hidden">
                 <div class="mb-4">
                    <button onclick="showTab('charts')" class="flex items-center text-sm font-bold text-aggie-gold hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        Back to Dataset
                    </button>
                </div>
                
                <div class="max-w-full mx-auto">
                    <h2 class="text-2xl font-bold text-center text-aggie-gold mb-4">
                        Historical Model Validation
                    </h2>
                    
                    <div class="flex justify-center gap-4 mb-8">
                        <button class="stat-button active" id="btn-validate-g4" onclick="switchValidation('game4')">Vs Game 4 (Morgan St.)</button>
                        <button class="stat-button inactive" id="btn-validate-g3" onclick="switchValidation('game3')">Vs Game 3 (Wash. Adv.)</button>
                    </div>

                    <p id="validation-desc" class="text-center text-gray-300 mb-8">
                        Comparing <strong>Player-Specific Predictions</strong> vs Actual Stats.
                    </p>
                    
                    <div class="overflow-x-auto bg-gray-900 rounded-lg shadow-xl border border-gray-700">
                        <table class="accuracy-table">
                            <thead>
                                <tr>
                                    <th class="w-1/4">Player</th>
                                    <th class="text-center">MIN</th>
                                    <th class="text-center">Pred PTS</th>
                                    <th class="text-center">Act PTS</th>
                                    <th class="text-center">Diff</th>
                                    <th class="text-center">Pred REB</th>
                                    <th class="text-center">Act REB</th>
                                </tr>
                            </thead>
                            <tbody id="accuracy-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-panel-visualization" class="tab-panel hidden">
                <div class="mb-4 flex justify-between items-center">
                    <button onclick="showTab('charts')" class="flex items-center text-sm font-bold text-aggie-gold hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        Back to Dataset
                    </button>
                </div>

                <!--https://raw.githubusercontent.com/kemoore-2/seniorproject_images/main/mensgames1-3_totalstats.png-->
                
                <div class="max-w-4xl mx-auto text-center">
                    <h2 class="text-2xl font-bold text-center text-aggie-gold mb-6">
                        Advanced Data Visualization
                    </h2>
                    
                    <div class="bg-gray-900 p-2 rounded-lg shadow-xl border border-gray-700 inline-block">
                        <img src="https://raw.githubusercontent.com/kemoore-2/seniorproject_images/main/mensgames1-3_totalstats.png" alt="Games 1-3 Positive Box Score Stats vs Minutes Per Game" class="max-w-full h-auto rounded">
                    </div>

                    <div class="bg-gray-900 p-2 rounded-lg shadow-xl border border-gray-700 inline-block">
                        <img src="https://raw.githubusercontent.com/kemoore-2/seniorproject_images/main/mensgames1-3_Trueshoot.png" alt=" Games 1-3 True Shooting Percentage vs Minutes Per Game" class="max-w-full h-auto rounded">
                    </div>
                    <div class="bg-gray-900 p-2 rounded-lg shadow-xl border border-gray-700 inline-block">
                        <img src="https://raw.githubusercontent.com/kemoore-2/seniorproject_images/main/mens_games1-3_assist_turnover.png" alt="Games 1-3 Assist to Turnover Ratio vs Minutes Per Game" class="max-w-full h-auto rounded">
                    </div>
                    <div class="bg-gray-900 p-2 rounded-lg shadow-xl border border-gray-700 inline-block">
                        <img src="https://raw.githubusercontent.com/kemoore-2/seniorproject_images/main/womensgames1-5_totalstats.png" alt="Games 1-5 Positive Box Score Stats vs Minutes Per Game" class="max-w-full h-auto rounded">
                    </div>
                    <div class="bg-gray-900 p-2 rounded-lg shadow-xl border border-gray-700 inline-block">
                        <img src="https://raw.githubusercontent.com/kemoore-2/seniorproject_images/main/womensgames1-5_Trueshoot.png" alt="Games 1-5 True Shooting Percentage vs Minutes Per Game" class="max-w-full h-auto rounded">
                    </div>
                    <div class="bg-gray-900 p-2 rounded-lg shadow-xl border border-gray-700 inline-block">
                        <img src="https://raw.githubusercontent.com/kemoore-2/seniorproject_images/main/womensgames1-5_Assist-Turnover.png" alt="Games 1-5 Assist to Turnover Ratio vs Minutes Per Game" class="max-w-full h-auto rounded">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- DATASET DEFINITIONS ---
        const datasets = {
            // Data from df_numeric (Season Averages - UPDATED to include Games 1-4)
            "men_season_avg": {
                name: "Men's Season Averages (Games 1-4)",
                players: [
                    {"#": "05", "Player": "Walker, Lewis", "AVG_MIN": 29.5, "AVG_PTS": 20.3, "AVG_REB": 6.3, "AVG_AST": 2.5}, 
                    {"#": "00", "Player": "Walker, Lureon", "AVG_MIN": 30.3, "AVG_PTS": 19.8, "AVG_REB": 2.5, "AVG_AST": 0.5}, 
                    {"#": "01", "Player": "Middleton, Jr., Trent", "AVG_MIN": 26.7, "AVG_PTS": 9.7, "AVG_REB": 3.0, "AVG_AST": 2.7}, 
                    {"#": "32", "Player": "Debrick, KJ", "AVG_MIN": 17.5, "AVG_PTS": 7.5, "AVG_REB": 5.3, "AVG_AST": 0.8}, 
                    {"#": "08", "Player": "Weluche-Ume, Zamoku", "AVG_MIN": 24.0, "AVG_PTS": 8.8, "AVG_REB": 3.3, "AVG_AST": 2.0}, 
                    {"#": "04", "Player": "Ogletree, Bryson", "AVG_MIN": 28.0, "AVG_PTS": 5.3, "AVG_REB": 3.8, "AVG_AST": 1.5},
                    {"#": "07", "Player": "Vick, Brooklyn", "AVG_MIN": 22.3, "AVG_PTS": 3.3, "AVG_REB": 1.8, "AVG_AST": 2.8},
                    {"#": "14", "Player": "Doumbia, Amadou", "AVG_MIN": 13.8, "AVG_PTS": 2.3, "AVG_REB": 5.3, "AVG_AST": 0.3},
                    {"#": "11", "Player": "Pierce, Dwayne", "AVG_MIN": 15.5, "AVG_PTS": 4.5, "AVG_REB": 1.5, "AVG_AST": 1.5}, 
                    {"#": "34", "Player": "Felton, Will", "AVG_MIN": 6.0, "AVG_PTS": 2.3, "AVG_REB": 1.3, "AVG_AST": 0.3}, 
                    {"#": "02", "Player": "Burton, Mujahiid", "AVG_MIN": 7.3, "AVG_PTS": 1.7, "AVG_REB": 0.7, "AVG_AST": 0.0},
                    {"#": "09", "Player": "Cueto, Yancarlos", "AVG_MIN": 16.0, "AVG_PTS": 4.0, "AVG_REB": 2.0, "AVG_AST": 2.0}
                ],
                stats: ["AVG_PTS", "AVG_REB", "AVG_AST", "AVG_MIN"]
            },
            // Data from df2_numeric (Women's Data remains unchanged)
            "women_season_avg": {
                name: "Women's Season Averages",
                players: [
                    {"#": "11", "Player": "Swangin, Jordyn", "AVG_MIN": 33.5, "AVG_PTS": 14.5, "AVG_REB": 2.9, "AVG_AST": 2.0, "AVG_BLK": 0.1, "AVG_STL": 1.4, "AVG_TO": 3.0},
                    {"#": "01", "Player": "Delaney, Maleia", "AVG_MIN": 31.9, "AVG_PTS": 13.0, "AVG_REB": 3.3, "AVG_AST": 2.2, "AVG_BLK": 0.2, "AVG_STL": 1.0, "AVG_TO": 2.1},
                    {"#": "23", "Player": "Wilson, Chaniya", "AVG_MIN": 27.6, "AVG_PTS": 11.5, "AVG_REB": 5.5, "AVG_AST": 0.9, "AVG_BLK": 1.4, "AVG_STL": 0.9, "AVG_TO": 2.2},
                    {"#": "03", "Player": "Henshaw, Paris", "AVG_MIN": 27.3, "AVG_PTS": 8.0, "AVG_REB": 6.0, "AVG_AST": 0.8, "AVG_BLK": 0.8, "AVG_STL": 1.3, "AVG_TO": 1.7},
                    {"#": "02", "Player": "Roberts, Laila", "AVG_MIN": 22.8, "AVG_PTS": 6.8, "AVG_REB": 2.6, "AVG_AST": 1.1, "AVG_BLK": 0.1, "AVG_STL": 0.9, "AVG_TO": 1.5},
                    {"#": "15", "Player": "Ndu, Jacquel", "AVG_MIN": 22.8, "AVG_PTS": 5.4, "AVG_REB": 4.1, "AVG_AST": 0.6, "AVG_BLK": 0.3, "AVG_STL": 0.9, "AVG_TO": 1.6},
                    {"#": "21", "Player": "Beach, Ture", "AVG_MIN": 22.8, "AVG_PTS": 4.9, "AVG_REB": 2.5, "AVG_AST": 1.2, "AVG_BLK": 0.2, "AVG_STL": 1.0, "AVG_TO": 1.5},
                    {"#": "00", "Player": "Dillard, Kiana", "AVG_MIN": 15.1, "AVG_PTS": 3.6, "AVG_REB": 1.9, "AVG_AST": 1.0, "AVG_BLK": 0.0, "AVG_STL": 0.5, "AVG_TO": 1.4},
                    {"#": "10", "Player": "Siu, Tsin", "AVG_MIN": 12.8, "AVG_PTS": 2.8, "AVG_REB": 1.5, "AVG_AST": 0.4, "AVG_BLK": 0.1, "AVG_STL": 0.3, "AVG_TO": 0.8},
                    {"#": "14", "Player": "Riffle, Ashara", "AVG_MIN": 11.5, "AVG_PTS": 2.8, "AVG_REB": 2.4, "AVG_AST": 0.4, "AVG_BLK": 0.4, "AVG_STL": 0.4, "AVG_TO": 0.7},
                    {"#": "05", "Player": "Key, Taliya", "AVG_MIN": 10.4, "AVG_PTS": 2.6, "AVG_REB": 1.1, "AVG_AST": 0.6, "AVG_BLK": 0.0, "AVG_STL": 0.5, "AVG_TO": 1.2},
                    {"#": "22", "Player": "Baker, Truly", "AVG_MIN": 10.1, "AVG_PTS": 1.8, "AVG_REB": 2.7, "AVG_AST": 0.1, "AVG_BLK": 0.3, "AVG_STL": 0.2, "AVG_TO": 0.6},
                    {"#": "20", "Player": "Bullock, Nahla", "AVG_MIN": 4.5, "AVG_PTS": 1.0, "AVG_REB": 0.3, "AVG_AST": 0.0, "AVG_BLK": 0.0, "AVG_STL": 0.0, "AVG_TO": 0.3},
                    {"#": "12", "Player": "Holloway, Zamareya", "AVG_MIN": 5.0, "AVG_PTS": 0.5, "AVG_REB": 0.5, "AVG_AST": 0.0, "AVG_BLK": 0.0, "AVG_STL": 0.0, "AVG_TO": 0.5},
                    {"#": "04", "Player": "Fields, Nyla", "AVG_MIN": 5.4, "AVG_PTS": 0.4, "AVG_REB": 1.1, "AVG_AST": 0.2, "AVG_BLK": 0.0, "AVG_STL": 0.2, "AVG_TO": 0.4},
                    {"#": "33", "Player": "Afonkina, Polina", "AVG_MIN": 3.3, "AVG_PTS": 0.3, "AVG_REB": 0.9, "AVG_AST": 0.0, "AVG_BLK": 0.1, "AVG_STL": 0.0, "AVG_TO": 0.4}
                ],
                stats: ["AVG_PTS", "AVG_REB", "AVG_AST", "AVG_MIN", "AVG_STL", "AVG_BLK", "AVG_TO"]
            },
            // NEW: Game 4 Data
            "men_game_11_18": {
                name: "Men's Game (11/18 vs Morgan St.)",
                players: [
                    {"#": "05", "Player": "Walker, Lewis", "MIN": 40, "PTS": 24, "REB": 9, "AST": 3, "BLK": 0, "STL": 2, "TO": 4},
                    {"#": "01", "Player": "Middleton Jr., Trent", "MIN": 36, "PTS": 13, "REB": 4, "AST": 3, "BLK": 0, "STL": 0, "TO": 6},
                    {"#": "07", "Player": "Vick, Brooklyn", "MIN": 33, "PTS": 6, "REB": 1, "AST": 2, "BLK": 0, "STL": 1, "TO": 1},
                    {"#": "00", "Player": "Walker, Lureon", "MIN": 25, "PTS": 10, "REB": 0, "AST": 0, "BLK": 0, "STL": 1, "TO": 2},
                    {"#": "04", "Player": "Ogletree, Bryson", "MIN": 28, "PTS": 9, "REB": 5, "AST": 2, "BLK": 0, "STL": 1, "TO": 2},
                    {"#": "32", "Player": "Debrick, KJ", "MIN": 24, "PTS": 8, "REB": 8, "AST": 0, "BLK": 1, "STL": 2, "TO": 1},
                    {"#": "08", "Player": "Weluche-Ume, Zamoku", "MIN": 23, "PTS": 6, "REB": 0, "AST": 2, "BLK": 0, "STL": 3, "TO": 1},
                    {"#": "14", "Player": "Doumbia, Amadou", "MIN": 8, "PTS": 0, "REB": 2, "AST": 0, "BLK": 0, "STL": 0, "TO": 0},
                    {"#": "34", "Player": "Felton, Will", "MIN": 8, "PTS": 3, "REB": 2, "AST": 1, "BLK": 0, "STL": 0, "TO": 0}
                ],
                stats: ["PTS", "REB", "AST", "MIN", "STL", "BLK", "TO"],
                summary: {
                    bench: 11,
                    fastBreak: 17,
                    offTurnovers: 17,
                    inPaint: 38
                }
            },
            // Data from Game 3 (11/13)
            "men_game_11_13": {
                name: "Men's Game (11/13 vs Wash. Adventist)",
                players: [
                    {"#": "00", "Player": "Walker, Lureon", "MIN": 32, "PTS": 25, "REB": 5, "AST": 0, "BLK": 1, "STL": 1, "TO": 2},
                    {"#": "08", "Player": "Weluche-Ume, Zamoku", "MIN": 27, "PTS": 17, "REB": 5, "AST": 1, "BLK": 3, "STL": 3, "TO": 1},
                    {"#": "04", "Player": "Ogletree, Bryson", "MIN": 38, "PTS": 9, "REB": 6, "AST": 2, "BLK": 0, "STL": 0, "TO": 2},
                    {"#": "07", "Player": "Vick, Brooklyn", "MIN": 24, "PTS": 2, "REB": 4, "AST": 5, "BLK": 0, "STL": 1, "TO": 2},
                    {"#": "32", "Player": "Debrick, KJ", "MIN": 6, "PTS": 2, "REB": 1, "AST": 0, "BLK": 1, "STL": 0, "TO": 0},
                    {"#": "05", "Player": "Walker, Lewis", "MIN": 31, "PTS": 25, "REB": 8, "AST": 4, "BLK": 0, "STL": 3, "TO": 2},
                    {"#": "09", "Player": "Cueto, Yancarlos", "MIN": 16, "PTS": 4, "REB": 2, "AST": 2, "BLK": 0, "STL": 3, "TO": 3},
                    {"#": "02", "Player": "Burton, Mujahiid", "MIN": 10, "PTS": 3, "REB": 0, "AST": 0, "BLK": 0, "STL": 0, "TO": 0},
                    {"#": "14", "Player": "Doumbia, Amadou", "MIN": 16, "PTS": 2, "REB": 6, "AST": 0, "BLK": 0, "STL": 1, "TO": 1}
                ],
                stats: ["PTS", "REB", "AST", "MIN", "STL", "BLK", "TO"],
                summary: {
                    bench: 34,
                    fastBreak: 27,
                    offTurnovers: 19,
                    inPaint: 50
                }
            },
            // Data from df3
            "men_game_11_10": {
                name: "Men's Game (11/04 vs S. Carolina)",
                players: [
                    {"#": "00", "Player": "Walker, Lureon", "MIN": 35, "PTS": 22, "REB": 1, "AST": 2, "BLK": 1, "STL": 0, "TO": 0},
                    {"#": "01", "Player": "Middleton, Jr., Trent", "MIN": 22, "PTS": 10, "REB": 3, "AST": 2, "BLK": 0, "STL": 1, "TO": 5},
                    {"#": "14", "Player": "Doumbia, Amadou", "MIN": 22, "PTS": 7, "REB": 10, "AST": 1, "BLK": 1, "STL": 1, "TO": 1},
                    {"#": "11", "Player": "Pierce, Dwayne", "MIN": 30, "PTS": 6, "REB": 3, "AST": 3, "BLK": 0, "STL": 1, "TO": 1},
                    {"#": "08", "Player": "Weluche-Ume, Zamoku", "MIN": 18, "PTS": 2, "REB": 2, "AST": 1, "BLK": 0, "STL": 0, "TO": 2},
                    {"#": "05", "Player": "Walker, Lewis", "MIN": 26, "PTS": 16, "REB": 4, "AST": 2, "BLK": 0, "STL": 1, "TO": 0},
                    {"#": "32", "Player": "Debrick, KJ", "MIN": 15, "PTS": 6, "REB": 2, "AST": 0, "BLK": 1, "STL": 1, "TO": 0},
                    {"#": "04", "Player": "Ogletree, Bryson", "MIN": 17, "PTS": 3, "REB": 3, "AST": 1, "BLK": 0, "STL": 1, "TO": 0},
                    {"#": "07", "Player": "Vick, Brooklyn", "MIN": 14, "PTS": 0, "REB": 0, "AST": 0, "BLK": 0, "STL": 3, "TO": 2},
                    {"#": "34", "Player": "Felton, Will", "MIN": 1, "PTS": 0, "REB": 0, "AST": 0, "BLK": 0, "STL": 0, "TO": 0}
                ],
                stats: ["PTS", "REB", "AST", "MIN", "STL", "BLK", "TO"],
                summary: {
                    bench: 25,
                    fastBreak: 28,
                    offTurnovers: 14,
                    inPaint: 34
                }
            },
            // Data from CleanNCATMensgame1_2full.csv
            "men_game_1_2_avg": {
                name: "Men's Game 1-2 Averages",
                players: [
                    {"#": "00", "Player": "Walker, Lureon", "AVG_MIN": 32.0, "AVG_PTS": 22.0, "AVG_REB": 2.5, "AVG_AST": 1.0},
                    {"#": "05", "Player": "Walker, Lewis", "AVG_MIN": 23.5, "AVG_PTS": 16.0, "AVG_REB": 4.0, "AVG_AST": 1.5},
                    {"#": "32", "Player": "Debrick, KJ", "AVG_MIN": 20.0, "AVG_PTS": 10.0, "AVG_REB": 7.0, "AVG_AST": 1.0},
                    {"#": "01", "Player": "Middleton, Jr., Trent", "AVG_MIN": 22.0, "AVG_PTS": 8.0, "AVG_REB": 2.5, "AVG_AST": 2.5},
                    {"#": "08", "Player": "Weluche-Ume, Zamoku", "AVG_MIN": 23.0, "AVG_PTS": 6.0, "AVG_REB": 4.0, "AVG_AST": 2.5},
                    {"#": "11", "Player": "Pierce, Dwayne", "AVG_MIN": 15.5, "AVG_PTS": 4.5, "AVG_REB": 1.5, "AVG_AST": 1.5},
                    {"#": "14", "Player": "Doumbia, Amadou", "AVG_MIN": 15.5, "AVG_PTS": 3.5, "AVG_REB": 6.5, "AVG_AST": 0.5},
                    {"#": "04", "Player": "Ogletree, Bryson", "AVG_MIN": 23.0, "AVG_PTS": 3.0, "AVG_REB": 2.0, "AVG_AST": 1.0},
                    {"#": "07", "Player": "Vick, Brooklyn", "AVG_MIN": 16.0, "AVG_PTS": 2.5, "AVG_REB": 1.0, "AVG_AST": 2.0},
                    {"#": "34", "Player": "Felton, Will", "AVG_MIN": 5.0, "AVG_PTS": 2.0, "AVG_REB": 1.5, "AVG_AST": 0.0},
                    {"#": "02", "Player": "Burton, Mujahiid", "AVG_MIN": 6.0, "AVG_PTS": 1.0, "AVG_REB": 1.0, "AVG_AST": 0.0},
                    {"#": "10", "Player": "Whittington, Chase", "AVG_MIN": 0.5, "AVG_PTS": 0.0, "AVG_REB": 0.0, "AVG_AST": 0.0}
                ],
                stats: ["AVG_PTS", "AVG_REB", "AVG_AST", "AVG_MIN"]
            },
             // Men's Game 1-3 Averages (Constructed for Historical Prediction)
            "men_game_1_3_avg": {
                name: "Men's Game 1-3 Averages",
                players: [
                    {"#": "00", "Player": "Walker, Lureon", "AVG_MIN": 32.0, "AVG_PTS": 23.0, "AVG_REB": 3.3, "AVG_AST": 0.7}, 
                    {"#": "05", "Player": "Walker, Lewis", "AVG_MIN": 26.0, "AVG_PTS": 19.0, "AVG_REB": 5.3, "AVG_AST": 2.3}, 
                    {"#": "32", "Player": "Debrick, KJ", "AVG_MIN": 15.3, "AVG_PTS": 7.3, "AVG_REB": 5.0, "AVG_AST": 0.7}, 
                    {"#": "01", "Player": "Middleton, Jr., Trent", "AVG_MIN": 22.0, "AVG_PTS": 8.0, "AVG_REB": 2.5, "AVG_AST": 2.5}, 
                    {"#": "08", "Player": "Weluche-Ume, Zamoku", "AVG_MIN": 24.3, "AVG_PTS": 9.7, "AVG_REB": 4.3, "AVG_AST": 2.0}, 
                    {"#": "11", "Player": "Pierce, Dwayne", "AVG_MIN": 15.5, "AVG_PTS": 4.5, "AVG_REB": 1.5, "AVG_AST": 1.5}, 
                    {"#": "14", "Player": "Doumbia, Amadou", "AVG_MIN": 15.7, "AVG_PTS": 3.0, "AVG_REB": 6.3, "AVG_AST": 0.3},
                    {"#": "04", "Player": "Ogletree, Bryson", "AVG_MIN": 28.0, "AVG_PTS": 4.0, "AVG_REB": 3.3, "AVG_AST": 1.3},
                    {"#": "07", "Player": "Vick, Brooklyn", "AVG_MIN": 18.7, "AVG_PTS": 2.3, "AVG_REB": 2.0, "AVG_AST": 3.0},
                    {"#": "34", "Player": "Felton, Will", "AVG_MIN": 5.0, "AVG_PTS": 2.0, "AVG_REB": 1.5, "AVG_AST": 0.0}, 
                    {"#": "02", "Player": "Burton, Mujahiid", "AVG_MIN": 7.3, "AVG_PTS": 1.7, "AVG_REB": 0.7, "AVG_AST": 0.0},
                    {"#": "09", "Player": "Cueto, Yancarlos", "AVG_MIN": 16.0, "AVG_PTS": 4.0, "AVG_REB": 2.0, "AVG_AST": 2.0} 
                ],
                stats: ["AVG_PTS", "AVG_REB", "AVG_AST", "AVG_MIN"]
            }
        };

        // --- GLOBAL VARIABLES ---
        let myChart;
        let currentDatasetKey = 'men_season_avg'; 
        let currentStat = 'AVG_PTS'; 
        
        // Models for prediction context (Current active prediction model)
        let activePredictionModels = {
            players: {} // Stores per-player coefficients
        };
        
        // --- TRAINING DATASETS FOR HISTORICAL CONTEXT ---
        // We pre-calculate models based on different historical points
        let historicalModels = {
            game3: { players: {} },
            game4: { players: {} },
            game5: { players: {} }
        };

        // Chart.js global defaults
        Chart.defaults.color = '#e0e0e0';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.font.family = 'Inter, sans-serif';
        Chart.defaults.font.weight = '500';

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupTabs();
            setupDatasetSelector();
            updateStatButtons();
            updateChart();
            trainAllHistoricalModels(); // Train all versions of the AI
            switchPredictionContext('game5'); // Default to latest
            updateTeamSummary(); 
            switchValidation('game4'); // Default validation view
        });

        // --- TAB CONTROLS ---
        function setupTabs() {
            document.getElementById('tab-btn-charts').classList.add('active');
            document.getElementById('tab-btn-charts').classList.remove('inactive');
            document.getElementById('tab-panel-charts').classList.remove('hidden');

            window.showTab = (tabName) => {
                // UPDATED: Added 'visualization' to the list of tabs
                const tabs = ['charts', 'prediction', 'accuracy', 'visualization'];
                tabs.forEach(tab => {
                    document.getElementById(`tab-btn-${tab}`).classList.remove('active');
                    document.getElementById(`tab-btn-${tab}`).classList.add('inactive');
                    document.getElementById(`tab-panel-${tab}`).classList.add('hidden');
                });
                document.getElementById(`tab-btn-${tabName}`).classList.add('active');
                document.getElementById(`tab-btn-${tabName}`).classList.remove('inactive');
                document.getElementById(`tab-panel-${tabName}`).classList.remove('hidden');
            };
        }

        // --- CHARTING LOGIC ---
        function setupDatasetSelector() {
            const selector = document.getElementById('dataset-select');
            selector.addEventListener('change', (e) => {
                currentDatasetKey = e.target.value;
                const availableStats = datasets[currentDatasetKey].stats;
                if (!availableStats.includes(currentStat)) {
                    currentStat = availableStats[0];
                }
                updateStatButtons();
                updateChart();
                updateTeamSummary();
            });
        }

        function updateStatButtons() {
            const container = document.getElementById('stat-buttons-container');
            container.innerHTML = ''; 
            const availableStats = datasets[currentDatasetKey].stats;
            
            availableStats.forEach(stat => {
                const button = document.createElement('button');
                button.textContent = stat;
                button.dataset.stat = stat;
                button.className = 'stat-button';
                if (stat === currentStat) {
                    button.classList.add('active');
                } else {
                    button.classList.add('inactive');
                }
                button.onclick = () => {
                    currentStat = stat;
                    updateStatButtons(); 
                    updateChart();
                };
                container.appendChild(button);
            });
        }
        
        function updateTeamSummary() {
            const container = document.getElementById('team-summary-container');
            const title = document.getElementById('team-summary-title');
            const data = datasets[currentDatasetKey];
            
            if (data.summary) {
                title.textContent = `Team Summary: ${data.name}`;
                document.getElementById('bench-points').textContent = data.summary.bench;
                document.getElementById('fast-break-points').textContent = data.summary.fastBreak;
                document.getElementById('points-off-turnovers').textContent = data.summary.offTurnovers;
                document.getElementById('points-in-paint').textContent = data.summary.inPaint;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function updateChart() {
            const { players } = datasets[currentDatasetKey];
            
            const sortedPlayers = [...players].sort((a, b) => {
                const valA = a[currentStat] === null ? -Infinity : a[currentStat];
                const valB = b[currentStat] === null ? -Infinity : b[currentStat];
                return valB - valA;
            });
            
            const labels = sortedPlayers.map(p => `${p.Player} (${p['#']})`);
            const dataValues = sortedPlayers.map(p => p[currentStat] === null ? 0 : p[currentStat]);

            const chartWrapper = document.getElementById('chart-wrapper');
            const baseHeight = 100; 
            const heightPerBar = 30; 
            const newHeight = Math.max(baseHeight + labels.length * heightPerBar, 400); 
            chartWrapper.style.height = `${newHeight}px`;

            const ctx = document.getElementById('playerStatsChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy(); 
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentStat,
                        data: dataValues,
                        backgroundColor: '#fdb927', 
                        borderColor: '#fdb927',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    indexAxis: 'y', 
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                borderColor: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e0e0e0'
                            }
                        },
                        y: {
                            grid: {
                                display: false 
                            },
                            ticks: {
                                color: '#e0e0e0',
                                autoSkip: false 
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false 
                        },
                        title: {
                            display: true,
                            text: `${datasets[currentDatasetKey].name}: ${currentStat}`,
                            color: '#fdb927', 
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: '#000',
                            titleColor: '#fdb927',
                            bodyColor: '#fff',
                            borderColor: '#fdb927',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.x !== null) {
                                        const val = datasets[currentDatasetKey].players[context.dataIndex][currentStat];
                                        if (val === null) {
                                            label += 'N/A';
                                        } else if (currentStat === 'AST_TO_RATIO') {
                                            label += val.toFixed(2);
                                        } else {
                                            label += context.parsed.x;
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- PLAYER-SPECIFIC MODEL TRAINING (Fixed Effects) ---
        function trainPlayerModels(datasetKey) {
            const players = datasets[datasetKey].players;
            const models = {};
            
            // For each player, calculate their "Efficiency per Minute"
            // In a real app, we'd regress over multiple games.
            // Here, we use their season average as the best predictor of their rate.
            players.forEach(player => {
                const min = Math.max(player.AVG_MIN, 1); // Avoid div by zero
                models[player.Player] = {
                    ppm: player.AVG_PTS / min, // Points per Minute
                    rpm: player.AVG_REB / min, // Rebounds per Minute
                    apm: player.AVG_AST / min  // Assists per Minute
                };
            });
            
            return models;
        }

        function trainAllHistoricalModels() {
            // 1. Model V1: Trained on Game 1-2 (Predicts G3)
            historicalModels.game3.players = trainPlayerModels('men_game_1_2_avg');

            // 2. Model V2: Trained on Game 1-3 (Predicts G4)
            historicalModels.game4.players = trainPlayerModels('men_game_1_3_avg');

            // 3. Model V3: Trained on Game 1-4 (Predicts G5)
            historicalModels.game5.players = trainPlayerModels('men_season_avg');
            
            // Default active model
            activePredictionModels = historicalModels.game5;
        }

        // --- PREDICTION TAB LOGIC ---
        document.getElementById('predict-game-select').addEventListener('change', (e) => {
            switchPredictionContext(e.target.value);
        });

        function switchPredictionContext(contextKey) {
            // 1. Swap the active brain
            activePredictionModels = historicalModels[contextKey];

            // 2. Update the player dropdown with the correct *baseline* data for that time
            let baselineKey = 'men_season_avg'; // Default (G1-4)
            if (contextKey === 'game3') baselineKey = 'men_game_1_2_avg';
            if (contextKey === 'game4') baselineKey = 'men_game_1_3_avg';
            
            const playerSelect = document.getElementById('player-select');
            playerSelect.innerHTML = ''; 
            
            // We need to filter to ensure we only show players who exist in the baseline dataset
            const baselinePlayers = datasets[baselineKey].players;
            
            baselinePlayers.forEach((player, index) => {
                const option = document.createElement('option');
                option.value = player.Player; // Use Name as ID for looking up model
                option.dataset.source = baselineKey;
                option.dataset.index = index;
                option.textContent = `${player.Player} (${player['#']})`;
                playerSelect.appendChild(option);
            });

            // 3. Update Context Text
            const contextText = document.getElementById('prediction-context-text');
            let contextLabel = "Games 1-4";
            if (contextKey === 'game3') contextLabel = "Games 1-2";
            if (contextKey === 'game4') contextLabel = "Games 1-3";
            
            contextText.innerHTML = `Using <strong>Player-Specific</strong> Efficiency Models trained on ${contextLabel}.`;
            
            // 4. Trigger update
            playerSelect.onchange = handlePlayerChange;
            playerSelect.selectedIndex = 0;
            handlePlayerChange();
        }

        function handlePlayerChange() {
            const playerSelect = document.getElementById('player-select');
            if (playerSelect.selectedIndex === -1) return;
            
            const selectedOption = playerSelect.options[playerSelect.selectedIndex];
            const playerName = selectedOption.value;
            const sourceKey = selectedOption.dataset.source;
            const index = selectedOption.dataset.index;
            
            const selectedPlayer = datasets[sourceKey].players[index];
            
            // Set input to player's current average minutes
            const avgMin = (selectedPlayer.AVG_MIN || 0);
            document.getElementById('minutes-input').value = avgMin.toFixed(1);
            document.getElementById('minutes-slider').value = Math.round(avgMin);
            
            // Show model specific info for this player
            const playerModel = activePredictionModels.players[playerName];
            if (playerModel) {
                const infoDisplay = document.getElementById('model-info');
                infoDisplay.innerHTML = `
                    <strong>${playerName}'s Rates:</strong><br>
                    ${playerModel.ppm.toFixed(2)} pts/min | 
                    ${playerModel.rpm.toFixed(2)} reb/min | 
                    ${playerModel.apm.toFixed(2)} ast/min
                `;
            }
            
            updatePrediction();
        }

        function updatePrediction() {
            const minutes = parseFloat(document.getElementById('minutes-input').value) || 0;
            const playerSelect = document.getElementById('player-select');
            if (playerSelect.selectedIndex === -1) return;
            
            const playerName = playerSelect.options[playerSelect.selectedIndex].value;
            const playerModel = activePredictionModels.players[playerName];
            
            if (!playerModel) {
                // Fallback if player has no history in this model
                 document.getElementById('pred-pts').textContent = "--";
                 document.getElementById('pred-reb').textContent = "--";
                 document.getElementById('pred-ast').textContent = "--";
                 return;
            }
            
            // Predict using PLAYER SPECIFIC rates
            const predPts = playerModel.ppm * minutes;
            const predReb = playerModel.rpm * minutes;
            const predAst = playerModel.apm * minutes;
            
            // Update UI
            document.getElementById('pred-pts').textContent = predPts.toFixed(1);
            document.getElementById('pred-reb').textContent = predReb.toFixed(1);
            document.getElementById('pred-ast').textContent = predAst.toFixed(1);
        }
        
        document.getElementById('minutes-input').addEventListener('input', updatePrediction);
        document.getElementById('minutes-slider').addEventListener('input', (e) => {
            document.getElementById('minutes-input').value = e.target.value;
            updatePrediction();
        });

        // --- ACCURACY TAB LOGIC ---
        window.switchValidation = (gameKey) => {
            // Update buttons
            document.getElementById('btn-validate-g4').className = gameKey === 'game4' ? 'stat-button active' : 'stat-button inactive';
            document.getElementById('btn-validate-g3').className = gameKey === 'game3' ? 'stat-button active' : 'stat-button inactive';

            const desc = document.getElementById('validation-desc');
            const tableBody = document.getElementById('accuracy-table-body');
            tableBody.innerHTML = '';

            let actualDataKey = '';
            let modelToUse = {}; // This will be the 'players' object

            if (gameKey === 'game4') {
                desc.innerHTML = "Comparing <strong>Game 1-3 Model</strong> (Player-Specific) vs Actual <strong>Game 4</strong> stats.";
                actualDataKey = 'men_game_11_18';
                modelToUse = historicalModels.game4.players; // Trained on G1-3
            } else {
                desc.innerHTML = "Comparing <strong>Game 1-2 Model</strong> (Player-Specific) vs Actual <strong>Game 3</strong> stats.";
                actualDataKey = 'men_game_11_13';
                modelToUse = historicalModels.game3.players; // Trained on G1-2
            }

            const actualData = datasets[actualDataKey].players;

            actualData.forEach(player => {
                const minutes = player.MIN;
                const actPts = player.PTS;
                const actReb = player.REB;
                const playerName = player.Player;
                
                // Get specific model for this player
                const pModel = modelToUse[playerName];
                
                let predPts = "--";
                let predReb = "--";
                let diffPts = "--";
                let diffClass = "diff-neutral";
                let diffSign = "";
                
                if (pModel) {
                     predPts = (pModel.ppm * minutes).toFixed(1);
                     predReb = (pModel.rpm * minutes).toFixed(1);
                     
                     diffPts = (actPts - parseFloat(predPts)).toFixed(1);
                     
                     // Determine color for Diff
                     diffClass = parseFloat(diffPts) > 0 ? 'diff-positive' : (parseFloat(diffPts) < 0 ? 'diff-negative' : 'diff-neutral');
                     diffSign = parseFloat(diffPts) > 0 ? '+' : '';
                }
                
                const row = `
                    <tr>
                        <td>${playerName}</td>
                        <td class="text-center">${minutes}</td>
                        <td class="text-center text-gray-400">${predPts}</td>
                        <td class="text-center font-bold">${actPts}</td>
                        <td class="text-center font-bold ${diffClass}">${diffSign}${diffPts}</td>
                        <td class="text-center text-gray-400">${predReb}</td>
                        <td class="text-center">${actReb}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

    </script>
</body>
</html>